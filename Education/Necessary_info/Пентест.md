____
**Тестирование на проникновение состоит из 4-х основных этапов**
![[Pasted image 20240812183223.png]]
____
## Этап 1. Сбор информации
____
### Nmap
Наиболее распространённая утилита для сканирования сетей - **_Nmap_**
Синтаксис:
`nmap <scan types> <options> <target>`
Метод сканирования по умолчанию - ==**TCP-SYN**==. Он позволяет сканировать несколько тысяч портов в секунду.
С вашей машины посылаются TCP-запросы с флагом SYN, что означает начало соединения, и если получен ответ с флагом ACK, то порт открыт, а если с флагом RST, то нет. Этот метод сканирования наиболее быстрый, так как полноценное соединения не устанавливается
Cуществуют также такие методы сканирования, как:
* **TCP Connect** - при этом методе сканирования производится попытка подключения с процедурой handshake. Соединение устанавливается полноценно на уровне операционной системы, поэтому такой вид подключения легче обнаружить.
* **UDP** сканирование - позволяет обнаружить на портах UDP-сервисы, такие как например DNS (port 53), NTP (port 123), SNMP (port 161), VPN (500, 1194, 4500). При сканировании отправляется пустой UDP-заголовок, если получен ответ в виде UDP-пакета, то порт открыт. Если получен получен ответ ICMP ==Destination port unreachable==, то порт порт закрыт. Ввиду того, что UDP часто теряет пакеты, при UDP-сканировании запросы на каждый порт посылаются несколько раз. Если ответ не получен, то статус порта определяется как "фильтруется" или "открыт". Для точного определения статуса порта в запросе посылается специальная полезная нагрузка.
* **TCP ACK сканирование** - единственная цель этого типа - выявить правила средств защиты. ICMP-запрос отправляется только с флагом ACK. У открытых и закрытых портов будет **одинаковая** реакция - ответ с флагом **RST**, а у фильтруемых - **Destination Unreachable**.
* TCP NULL, FIN, Xmas - более скрытный тип сканирования, чем например TCP-SYN. Ввиду особенностей спецификации **RFC 793**, на закрытом порте запрос, не содержащий флага RST, спровоцирует ответ с RST-флагом, а когда порт открыт - ответа не будет. Все эти 3 вида сканирования основаны на вышеописанном и просто отправляют запросы с разными флагами (TCP NULL - без флагов, FIN - флаг FIN, Xmas - флаги FIN, PSH, URG).
* Ленивое (зомби) сканирование - отправка запросов происходит не с локального ip-адреса, а с любой слабо-загруженной машины в сети. Это самый скрытный способ сканирования [подробнее](https://nmap.org/book/idlescan.html) 
____
Чтобы провести сканирование сети, лучше всего использовать отправку эхо-запросов по протоколу **ICMP**. 

**ICMP** (Internet Control Message Protocol) — это протокол третьего уровня модели OSI, который используется для диагностики проблем со связностью в сети.

Одно из самых популярных применений ICMP — это утилиты `ping` и `traceroute`.
____
**Полезные опции Nmap**
* `-iL <имя входного файла>`: Использовать список хостов/сетей из файла
* `-sP`: Пинг сканирование - просто определить, работает ли хост
* `--exclude <хост1[,хост2][,хост3],...>`: Исключить хосты/сети
* `--excludefile <имя_файла>`: Исключить из сканирования список хостов/сетей, находящийся в файле
* `-PE`: пингование с использованием ICMP
* `--traceroute`: Трассировка пути к хосту
Больше опций можно увидеть по [ссылке](https://nmap.org/man/ru/man-briefoptions.html)
___
В NMAP существуют скрипты - файлы с расширением .nse (NMAP Script Engine)

Один из наиболее используемых скриптов является ==**_smb-os-discovery.nse==_**. Он используется для получения данных об ОС хоста. Данный скрипт работает через протокол SMB, реализующий общий доступ к файлам, принтерам и другим устройствам в сети.
Пример использования:
`nmap -p 139,445 --script smb-os-discovery <target>`

Ещё несколько полезных скриптов:
* **_==smb-vuln-ms17-010.nse==_**, с помощью него можно определить, уязвим ли сервер Microsoft SMBv1 (самая ранняя версия протокола SMB) к [CVE-2017-0143](https://nvd.nist.gov/vuln/detail/CVE-2017-0143)
  Пример использования:
  `nmap -p445 --script smb-vuln-ms17-010 <target>`
* **_==pop3-ntlm-info==_** возвращает информацию из удаленных служб POP3 с включенной проверкой подлинности NTLM (NT LAN Manager — протокол аутентификации, используемый в операционных системах Windows для проверки подлинности пользователей и предоставления доступа к ресурсам в сети.)
  Пример использования:
  `nmap -p 110,995 --script pop3-ntlm-info <target>`
* ==***nbstat.nse***== - пытается получить NetBIOS-имена и MAC-адрес целевого объекта.
  Немного про **NetBIOS**. NetBIOS - протокол для работы в локальных сетях на персональных ЭВМ типа IBM/PC, разработан в виде интерфейса, который не зависит от фирмы-производителя.
  `port 137 - служба имён`
  `port 138 - служба дейтаграм`
  `port 139 - для сессий`
  [Подробнее](https://hackware.ru/?p=11458)

Больше скриптов можно найти по [ссылке](https://nmap.org/nsedoc/scripts/)
____
Для сканирования сетей можно также выделить утилиту **_RustScan_** 
____
## Этап 2. Целенаправленной проникновение
____
### Поиск уязвимостей на хостах. Популярные инструменты
____
#### CrackMapExec
____
#### Medusa
____
#### Metasploit Framework
____
#### Exploit-DB
____
#### Webshot
____
### Распределение уязвимостей по категориям
* аутентификация
* патчи
* конфигурация
----
### Брутфорс (BruteForce)
Популярными инструментами для брутфоса являются:
#### CrackMapExec
Пример:
`cme smb 192.168.1.101 -u /path/to/users.txt -p /path/to/passwords.txt --local-auth`

Полезная опция `--no-bruteforce` позволяет установить соответствие между пользователем и паролем, тем самым облегчая задачу поиска валидных учётных записей
____
#### Medusa
____
#### THC - Hydra
____
#### Metasploit
____
### Password spraying
Попытки аутентификации для большого количества пользователей с использованием одного пароля также является распространённой техникой.

Пример с использованием утилиты CrackMapExec:

`cme smb 192.168.1.101 -u /path/to/users.txt -p Summer2024 --continue-on-success`
____
### Оболочки Shell и полезные нагрузки.
____
#### Reverse shell
Схема, подразумевающая под собой то, что на машине злоумышленника поднимается сервер, на котором открывается порт, а к нему подключается целевое устройство, таким образом, например, можно обойти брандмауэр.
К тому же, злоумышленнику не нужно знать ip-адрес жертвы, так как она сама подключится к его порту.
Если на хосте присутствует уязвимость выполнения произвольного кода **RCE**, то ваш путь - Reverse Shell

Его запуск можно совершить например с помощью Netcat.
Командой `nс -nvlp 443` можно открыть запустить у себя сервер, принимающий TCP-запросы на порт 443

____
#### Bind shell
Bind Shell - схема, в которой целевая машина выступает как сервер, а злоумышленник подключается к ней как клиент к открытому порту

Для запуска Bind Shell должен быть известен IP-адрес жертвы

На машине жертвы запустим команду
``nc -lnvp 3333 -e /bin/sh``

На машине атакующего выполним
``nc -nv <IP-адрес жертвы> 3333``

![[Pasted image 20240819223611.png]]
____
### Эксплуатация уязвимостей
#### EternalBlue
Одной из наиболее распространённых является уязвимость **==EternalBlue==** 

Данная уязвимость совместно с бэкдором DoublePulsar являются базой для таких зловредов как WannaCry и NotPetya (программы вымогатели)
Используя их, злоумышленник может получить права уровня System (самые высокие), что может привести к компрометации всего домена.

Данная уязвимость возникает в ОС Windows Server результате сбоя в обработке SMB (порт 445) запроса. Специально сконструированный SMB-пакет вызывает целочисленное переполнение, что приводит к BufferOverflow и, следовательно, к RCE (совместно с бэкдором DoublePulsar, который собственно и помогает запускать вредоносный код)

Особенность SMB - отсутствие сегментации, что создаёт возможность горизонтального перемещения внутри сети, а соответственно и распространения вредоноса

В 2017 году был выпущен патч с исправлением данной уязвимости MS17-010

Обнаружить и проэксплуатировать данную уязвимость можно при помощи MSF Framework.

 ``search ms17_010``
 ``set RHOSTS <ip adrdress>``
 ``run``

Лакомым куском в данном случая являются ОС ниже Win8, так как для эксплуатации будут доступны анонимные NULL сессии (то есть ну понадобятся сведения об учётных записях или named pipes)
![[Pasted image 20240819224418.png]]![[Pasted image 20240819224423.png]]
![[Pasted image 20240819224429.png]]![[Pasted image 20240819224435.png]]
____
#### BlueKeep
Ещё одна из критических и очень известных уязвимостей является BlueKeep (CVE-2019-0708) - уязвимость в RDP-службе, дающая возможность RCE без необходимости аутентификации.
Уязвимость касается Windows XP, Windows Vista, Windows 7, Windows Server 2003 и Windows Server 2008.
____
#### Уязвимости Exchange и OWA
Многие организации используют решения от Microsoft для организации отправки и получения писем (Exchange и OWA), которые содержат критические уязвимости, такие как:

- ProxyLogon: позволяет злоумышленнику обойти аутентификацию и выдать себя за администратора. 
 
- ProxyShell: набор из трех уязвимостей, которые позволяют удаленное выполнение кода без аутентификации. 
 
- ProxyToken: позволяет злоумышленнику получить письма произвольных пользователей.

Все их можно выявить с помощью фреймворка Metasploit.
![[Pasted image 20240819224804.png]]
![[Pasted image 20240819224811.png]]
![[Pasted image 20240819224817.png]]
____
#### Свежие уязвимости
Из свежих можно вспомнить уязвимости CVE-2024-27198 & CVE-2024-27199 - RCE в продукте CI/CD JetBrains TeamCity

____
### Обход антивирусного ПО
#### Herpaderping
Process Herpaderping - манипуляции с отображением исполняемого файла в память до закрытия его дескриптора.

При запуске или завершении процесса функция ядра **==PsCreateProcessNotifyRoutine()==** создаёт оповещение. Но создаётся оно только в тот момент, когда создаётся первый поток. 
Это позволяет злоумышленникам создать сам процесс, отобразить его в память, а затем заменить содержимое исполняемого файла на что-то легитимное, и только потом создать первый поток.

Herpaderping по шагам:
- Создание процесса с вредоносным файлом (при этом оставляем дексриптор handle открытым).
- Создание image section (осо­бый раз­дел и слу­жит для отоб­ражения фай­ла в память) с помощью NtCreateSection с флагом SEC_IMAGE. Раз­дел соот­ветс­тву­ет PE-фай­лам и может быть соз­дан толь­ко в них. 
- Отображение полезной нагрузки в созданный раздел image section с последующей заменой содержимого файла на что-нибудь легитимное
- Создание initial thread с помощью NtCreateThreadEx (как раз в этот момент и сработает callback создания процесса в ядре). Антивирус, видя различия между содержимым файла и его отображением в памяти, не поймёт, стоит ли разрешать запуск данного процесса.
- Закрытие дескриптора с помощью IRP_MJ_CLEANUP для корректного выполнения
[Реализация Herpaderping самостоятельно](https://www.securitylab.ru/analytics/535253.php) 
____
#### Ghosting
Ghosting - манипуляции с "удалением" исполняемого файла

Ghosting по шагам:
- Создание файла и перевод его в состояние delete-pending, используя NtSetInformationFile с флагом FILE_DELETE_ON_CLOSE (файл не удалится, пока дескриптор открыт)
- Копирование полезной нагрузки в созданный файл (содержимое не сохранится, так как файл "удалён", а также будет заблокированы попытки открыть файл извне
- Создание image section и отображение содержимого в память
- Закрытие дескриптора, что влечёт за собой удаление файла
- Создание нового процесса с тем же дескриптором, а затем создание initial thread. В этот момент антивирус получит оповещение о создании процесса, но попытка открыть файл завершится с ошибкой STATUS_FILE_DELETED.

Таким образом, полезная нагрузка осталась отображённой в памяти, но антивирусное ПО не может обнаружить вредонос ввиду удаления файла.
[Реализация Ghosting самостоятельно](https://telegra.ph/Uklonenie-ot-sredstv-zashchity-2-CHast-07-14)
____
#### Обход статического анализа
Так же обход антивирусного ПО осуществляется с помощью обмана статического анализа. Обычно он производится путём определения контрольной суммы двоичного файла (уникальный идентификатор), а также извлечением информации из самого файла (описание, название компании, цифровые подписи, строки, названия функций)

Способы обмана:
- Хеширование. Может быть использовано например для скрытия строк, которые могут быть сигнатурами для обнаружения вредоносных файлов.
- Шифрование. Можно определённым образом зашифровать вредоносный файл, но это потребует установки загрузчика для расшифровки и запуска по в памяти
- Обфускация. Искусственное запутывание кода, делающее его нечитаемым (в том числе и для антивируса)

[Полезные инструменты](https://telegra.ph/Uklonenie-ot-sredstv-zashchity-3-CHast-07-16)
____

### C&C
Для закрепления на узле и обеспечения канала передачи украденных данных требуется надёжная инфраструктура управления и контроля (C&C или C2) 

Распространённой технологией является смешивание с другими типами легитимного трафика (HTTP/HTTPS или DNS).

Хакеры и пентестеры часто используют для этого такие популярные платформы, как Cobalt Strike, Covenant, Havoc, Sliver, Powershell Empire и Metasploit.

**Характерная терминология**:
- payload - нагрузка, обеспечивающая непрерывное подключение к серверу (reverse или bind shell)
- stage - метод загрузки
- beaconing - отправка вызовов в инфраструктуру C&C для проверки инструкций

**Возможности C&C**
- создание reverse shell с постоянным каналом связи
- модули сбора данных, удаления бэкдоров, заметание следов атаки
- туннелирование и перенаправление портов
- установка ПО на целевое устройство, или выгрузка данных с него
____
## Microsoft Active Directory
### Основные понятия
Microsoft AD интегрирована со множеством служб и приложений (например DNS, DHCP, Exchange Server)

Основные понятия AD:
- Объект - любой ресурс (принтер, пользователь, контроллер домена и т.д.)
- Атрибуты - характеристики объекта (обязательные и опциональные)
- Схема определяет, какие типы объектов могут существовать в базе данных, а так же их атрибуты. С ней хранится информация о каждом объекте.
- Домен - логическая группа объектов
- Лес - совокупность доменов AD. Контейнер самого верхнего уровня, содержащий все объекты AD
- Дерево - совокупность доменов, начинающихся с одного корневого домена
- Windows server, на котором установлена служба ADDS называется контроллером домена (DC).
- Global Catalog - роль контроллера домена, который хранит краткую информацию о всем лесе
- NTDS.DIT - база Active Directory, копия которой присутствует на каждом DC
- GUID (Global Unique Identifier) - 128-битный идентификатор объекта
- Субъекты безопасности - всё, что система может аутентифицировать (объекты и их активность)
____
### Полезные понятия
- SID - уникальный идентификатор участника или группы безопасности. Он может быть использован только один раз (например, если политика безопасности будет удалена, его нельзя будет использовать для идентификации других объектов). SID используется для проверки прав пользователя. Существуют также широко известные SID, идентифицирующие общих пользователей и группы.
- DN - полный путь к объекту AD
- RDN - относительный DN
- sAMAccountName - имя для входа пользователя
- Атрибут userPrincipalName - способ идентификации (имя в формате bjones@inlanefreight.local.)
- Read-Only Domain Controller (RODC) - контроллер домена только для чтения
- Репликация - синхронизация изменений со всеми другими контроллерами в лесу, помогая например создавать резервную копию. Происходит это всё с помощью службы KCC (Knowledge Consistency Checker)
- Service Principal Name (SPN) — однозначно идентифицирует экземпляр службы. Используется в Kerberos для связи экземпляра службы с учётной записью входа, позволяя производить проверку корректности учётных данных без необходимости знать имя пользователя
- Групповые политики (GPO) - настройки широкого спектра объектов с помощью централизованных политик
- Access Control List (ACL) - набор записей контроля доступа ACE, применяемых к объекту
- Access Control Entries (ACE) - идентифицирует учётку группы, учётку пользователя и перечисляет права доступа
- DACL (Discretionary Access Control List) - особенный список ACE, позволяющий защищать объект. Если DACL пустой, то доступ запрещён всем пользователям, а если его вообще нет, то доступ разрешён всем.
- Списки управления доступом к системе (SACL) - позволяет мониторить попытки доступа к защищённым объектам и регистрировать их в журналах
- FQDN - полное имя компьютера в формате DC01.INLANEFREIGHT.LOCAL.
____
### Права и привилегии в Active Directory
#### Права
Права назначаются пользователям или группам и имеют дело с разрешением на доступ к конкретному объекту (например - файл).

Привилегии предоставляют пользователю разрешение на выполнение каких-либо действий в ОС

Дефолтные группы AD:

- Account Opeartors. Есть возможность создавать и изменять большинство видов учётных записей, а также входить локально на контроллер домена. Они не могут оперировать учётками админов и других операторов
- Administrators. Неограниченный доступ ко всему домену.
- Backup Operators. Могут создавать резервные копии, восстанавливать файлы, создавать теневые копии базы данных SAM/NTDS для извлечения учётных данных
- DNS Admins. Доступ к сетевой информации DNS
- Domain Admins. Имеют полный доступ к администрированию домена
- Domain Users. Все учетный записи пользователей в домене
- Enterprise Admins. Полный доступ к настройкам в пределах домена (присутствует только в корневом домене)
- Group Policy Creator Owners. Работают с групповыми политиками
- Hyper-V Administrators. Полный и неограниченный доступ ко всем функциям Hyper-V
- Protected Users. Членам этой группы предоставляется дополнительная защита от кражи учетных данных.
- Schema Admins. Могут изменять схему Active Directory.
- Server Operators. Группа, существующая только на контроллерах домена, участники которой могут изменять службы, получать доступ к файлам через SMB
____
#### Привилегии
- SeRemoteInteractiveLogonRight - предоставления возможность подключаться через RDP
- SeBackupPrivilege - возможность создавать резервные копии, получать доступ к копиям конфиденциальных системных файлов (например для смены пароля)
- SeDebugPrivilege -  Позволяет пользователю выполнять отладку и настройку памяти процесса. 
- SeImpersonatePrivilege - ?
- SeLoadDriverPrivilege -    Пользователь с этой привилегией может загружать и выгружать драйверы устройств, которые потенциально могут быть использованы для повышения привилегий или компрометации системы.
____
## Аутентификация пользователей
### Kerberos
Протокол аутентификации для учётных записей домена, основанный на билетах (вместо передачи паролей по каналам связи). 

Каждый контроллер домена AD имеет службу распространения билетов Kerberos (KDC). 

- При входе в систему клиент запрашивает билет у KDC, шифруя запрос паролем пользователя
- Если KDC смог расшифровать запрос (AS-REQ), то он создаёт билет на получения билета TGT и передаёт его пользователю
- Пользователь отправляет свой TGT контроллеру домена для запроса выдачи билета TGS, зашифрованного с помощью хэша NTLM пароля 
- Клиент запрашивает доступ к сервису, предоставляя свой TGS

Проверка Kerberos гарантирует, что пароли пользователей по сети не передаются
____
### DNS
ADDS используют DNS для того, чтобы позволить клиентам находить контроллеры домена, а контроллерам, на которых размещена служба каталогов, взаимодействовать между собой

- При присоединении клиента к сети, он находит контроллер домена, отправив запрос в службу DNS.
- В ответ он получает запись SRV из базы данных DNS
- Затем клиент уже использует имя хоста для получения ip-адреса контроллера домена

DNS слушает 53 порт TCP/UDP
____
### NTHash (NTLM)
Для аутентификации используются три сообщения:

1) NEGOTIATE_MESSAGE
2) CHALLENGE_MESSAGE
3) AUTHENTICATE_MESSAGE

Хэши с паролем хранятся локально в базе данных SAM или в файле базы данных NTDS.DIT 
Алгоритм можно представить как MD4(UTF-16-LE(password))

Эти хэши можно быстро перебрать с помощью утилиты HashCat.
NTLM также уязвим для атаки pass-the-hash (злоумышленник может использовать только NTLM хэш, который он получил в результате другой атаки, без необходимости знать сам пароль)

Как выглядит хэш

``Рэйчел:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::``

``Рэйчел`` - имя пользователя
``500`` - RID для учётки админа
``aad3c435b514a4eeaad3b935b51304fe`` - NT-хэш
``e46b9e548fa0d122de7f59fb6d48eaa2`` - LM-хэш

Как раз таки NT хэш используется для атаки pass-the-hash
____
### LDAP
Облегчённый протокол доступа к каталогам (порт 389, а LDAP через SSL слушает порт 636). LDAP - язык запросов для совместного доступа к службе каталогов. Благодаря ему машины могут общаться с AD